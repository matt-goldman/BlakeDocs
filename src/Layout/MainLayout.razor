@inherits LayoutComponentBase
@using BlakeSampleDocs.Components
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<TopBar />

<div class="main-container">
    <div class="row g-0 h-100">
        <!-- Left Sidebar - Site Navigation (Desktop Only) -->
        <nav class="col-lg-2 col-md-3 sidebar-left d-none d-md-block">
            <div class="sidebar-content">
                <div class="toc-scrollable">
                    <SiteToc ActiveSlug="@_activeSlug" Nodes="@_contentIndex" />
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main role="main" class="col-12 col-md-6 col-lg-8 main-content" id="main-content" data-bs-spy="scroll" data-bs-target="#bs-scroll-target" tabindex="0">
            <div class="content-wrapper">
                @Body
            </div>

            <footer class="border-top footer text-muted">
                <div class="container">
                    &copy; @DateTime.Now.Year - BlakeDocs
                </div>
            </footer>
        </main>

        <!-- Right Sidebar - Popular Articles (Desktop Only) -->
        <aside class="col-lg-2 col-md-3 sidebar-right d-none d-md-block">
            <div class="sidebar-content">
                <SectionOutlet SectionName="Sidebar" />
            </div>
        </aside>
    </div>
</div>

<!-- Mobile Site Navigation Offcanvas -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="siteNavOffcanvas" aria-labelledby="siteNavOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="siteNavOffcanvasLabel">Site Navigation</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <!-- Mobile Search Link -->
        <div class="mobile-search-section mb-4">
            <a href="/search/" class="btn btn-outline-light w-100 d-flex align-items-center justify-content-center gap-2">
                <Blazicon Svg="FontAwesomeSolidIcon.MagnifyingGlass" />
                Search Documentation
            </a>
        </div>
        <SiteTocMobile ActiveSlug="@_activeSlug" Nodes="@_contentIndex" />
    </div>
</div>

<!-- Mobile Page TOC Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="pageTocOffcanvas" aria-labelledby="pageTocOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="pageTocOffcanvasLabel">On This Page</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <SectionOutlet SectionName="MobileSidebar" />
    </div>
</div>

@code {

    private List<TocNode> _contentIndex = [];

    private string _activeSlug = string.Empty;

    protected override void OnInitialized()
    {
        var pages = GeneratedContentIndex.GetPages();

        _contentIndex = TocUtils.BuildSiteTocNodes(pages);

        NavigationManager.LocationChanged += async (sender, args) =>
        {
            UpdateSlugs();

            if (!args.IsNavigationIntercepted) return;

            await JSRuntime.InvokeVoidAsync("scrollToTop");
        };

        base.OnInitialized();
    }

    private void UpdateSlugs()
    {
        // Get the current page slug from the URL
        _activeSlug = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);

        if (!_activeSlug.StartsWith("/"))
        {
            _activeSlug = "/" + _activeSlug; // Ensure it starts with a slash
        }

        StateHasChanged();
    }
}
